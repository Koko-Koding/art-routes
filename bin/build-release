#!/bin/bash

# WP Art Routes - Build Release Script
# This script creates a zip file for WordPress.org distribution

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_DIR="$(dirname "$SCRIPT_DIR")"
PLUGIN_NAME="wp-art-routes"

# Extract version from main plugin file
VERSION=$(grep "Version:" "$PLUGIN_DIR/wp-art-routes.php" | head -1 | awk -F: '{print $2}' | tr -d ' ')

if [ -z "$VERSION" ]; then
    echo -e "${RED}Error: Could not extract version from wp-art-routes.php${NC}"
    exit 1
fi

echo -e "${YELLOW}Building WP Art Routes v$VERSION for distribution...${NC}"

# Create build directory
BUILD_DIR="$PLUGIN_DIR/build"
RELEASE_DIR="$BUILD_DIR/$PLUGIN_NAME"
ZIP_FILE="$BUILD_DIR/$PLUGIN_NAME-$VERSION.zip"

# Clean and create build directory
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
fi
mkdir -p "$RELEASE_DIR"

echo -e "${YELLOW}Copying files to build directory...${NC}"

# Copy files that should be included in distribution
cp "$PLUGIN_DIR/wp-art-routes.php" "$RELEASE_DIR/"
cp "$PLUGIN_DIR/readme.txt" "$RELEASE_DIR/"
cp "$PLUGIN_DIR/README.md" "$RELEASE_DIR/"
cp "$PLUGIN_DIR/CHANGELOG.md" "$RELEASE_DIR/"

# Copy directories
cp -r "$PLUGIN_DIR/assets" "$RELEASE_DIR/"
cp -r "$PLUGIN_DIR/includes" "$RELEASE_DIR/"
cp -r "$PLUGIN_DIR/languages" "$RELEASE_DIR/"
cp -r "$PLUGIN_DIR/templates" "$RELEASE_DIR/"

# Remove any unwanted files that might have been copied
find "$RELEASE_DIR" -name ".DS_Store" -delete 2>/dev/null || true
find "$RELEASE_DIR" -name "Thumbs.db" -delete 2>/dev/null || true
find "$RELEASE_DIR" -name "*.log" -delete 2>/dev/null || true

echo -e "${YELLOW}Creating zip file...${NC}"

# Create zip file
cd "$BUILD_DIR"
zip -r "$PLUGIN_NAME-$VERSION.zip" "$PLUGIN_NAME" -q

# Move back to original directory
cd "$PLUGIN_DIR"

# Check if zip was created successfully
if [ -f "$ZIP_FILE" ]; then
    ZIP_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
    echo -e "${GREEN}✓ Successfully created: $ZIP_FILE ($ZIP_SIZE)${NC}"
    echo -e "${GREEN}✓ Ready for WordPress.org submission!${NC}"
    
    echo ""
    echo -e "${YELLOW}Files included in the distribution:${NC}"
    # Use zipinfo instead of unzip -l for better filename handling with spaces
    zipinfo -1 "$ZIP_FILE" | grep -v "/$" | sed 's/^/  /' | sort
    
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "1. Test the plugin by installing the zip file on a WordPress site"
    echo "2. Upload to WordPress.org if everything works correctly"
    echo "3. Tag the release in git: git tag v$VERSION"
else
    echo -e "${RED}Error: Failed to create zip file${NC}"
    exit 1
fi