#!/bin/bash

# Art Routes Pro - Build Release Script
# This script creates a zip file for distribution

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
PLUGIN_DIR="$REPO_ROOT/plugins/art-routes-pro"
PLUGIN_NAME="art-routes-pro"

# Extract version from main plugin file
VERSION=$(grep "Version:" "$PLUGIN_DIR/art-routes-pro.php" | head -1 | awk -F: '{print $2}' | tr -d ' ')

if [ -z "$VERSION" ]; then
    echo -e "${RED}Error: Could not extract version from art-routes-pro.php${NC}"
    exit 1
fi

echo -e "${YELLOW}Building Art Routes Pro v$VERSION for distribution...${NC}"

# Create build directory at repo root
BUILD_DIR="$REPO_ROOT/build"
RELEASE_DIR="$BUILD_DIR/$PLUGIN_NAME"
ZIP_FILE="$BUILD_DIR/$PLUGIN_NAME-$VERSION.zip"

# Clean and create build directory
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
fi
mkdir -p "$RELEASE_DIR"

echo -e "${YELLOW}Copying files to build directory...${NC}"

# Copy files that should be included in distribution
cp "$PLUGIN_DIR/art-routes-pro.php" "$RELEASE_DIR/"

# Copy directories
cp -r "$PLUGIN_DIR/includes" "$RELEASE_DIR/"
cp -r "$PLUGIN_DIR/assets" "$RELEASE_DIR/"
cp -r "$PLUGIN_DIR/lib" "$RELEASE_DIR/"

# Remove any unwanted files that might have been copied
find "$RELEASE_DIR" -name ".DS_Store" -delete 2>/dev/null || true
find "$RELEASE_DIR" -name "Thumbs.db" -delete 2>/dev/null || true
find "$RELEASE_DIR" -name "*.log" -delete 2>/dev/null || true
find "$RELEASE_DIR" -name ".gitkeep" -delete 2>/dev/null || true

echo -e "${YELLOW}Creating zip file...${NC}"

# Create zip file
cd "$BUILD_DIR"
zip -r "$PLUGIN_NAME-$VERSION.zip" "$PLUGIN_NAME" -q

# Move back to repo root
cd "$REPO_ROOT"

# Check if zip was created successfully
if [ -f "$ZIP_FILE" ]; then
    ZIP_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
    echo -e "${GREEN}✓ Successfully created: $ZIP_FILE ($ZIP_SIZE)${NC}"
    echo -e "${GREEN}✓ Ready for distribution!${NC}"

    echo ""
    echo -e "${YELLOW}Files included in the distribution:${NC}"
    zipinfo -1 "$ZIP_FILE" | grep -v "/$" | sed 's/^/  /' | sort

    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "1. Test the plugin by installing the zip file on a WordPress site"
    echo "2. Tag the release in git: git tag pro-v$VERSION"
else
    echo -e "${RED}Error: Failed to create zip file${NC}"
    exit 1
fi
