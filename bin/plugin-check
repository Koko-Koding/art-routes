#!/bin/bash

# Plugin Check Script for Art Routes
# Runs WordPress Plugin Check on the release build (not dev files)
#
# Usage: ./bin/plugin-check
#
# This script:
# 1. Builds the release package (creates clean build/art-routes/)
# 2. Copies it to a temporary location in wp-content/plugins/
# 3. Runs wp plugin check on the clean copy using Local's environment
# 4. Cleans up the temporary copy

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
PLUGIN_DIR="$REPO_ROOT/plugins/art-routes"
WP_PLUGINS_DIR="/Users/drikusroor/Local Sites/art-routes/app/public/wp-content/plugins"
WP_DIR="/Users/drikusroor/Local Sites/art-routes/app/public"
TEST_PLUGIN_NAME="art-routes-check"
TEST_PLUGIN_DIR="$WP_PLUGINS_DIR/$TEST_PLUGIN_NAME"

# Local by Flywheel paths
LOCAL_SUPPORT_DIR="$HOME/Library/Application Support/Local"
LOCAL_SSH_ENTRY_DIR="$LOCAL_SUPPORT_DIR/ssh-entry"

echo -e "\033[1;33mArt Routes Plugin Check\033[0m"
echo "========================"
echo ""

# Step 0: Find the Local site ID from sites.json
echo -e "\033[1;33m0. Detecting Local by Flywheel site...\033[0m"

# Get the Local site root (strip /app/public from WP_DIR)
LOCAL_SITE_ROOT=$(echo "$WP_DIR" | sed 's|/app/public$||')

# Find site ID from sites.json
LOCAL_SITE_ID=""
if [ -f "$LOCAL_SUPPORT_DIR/sites.json" ]; then
    # Extract site IDs and paths, find the one matching our path
    LOCAL_SITE_ID=$(python3 -c "
import json
import os
import sys
try:
    with open(os.path.expanduser('~/Library/Application Support/Local/sites.json'), 'r') as f:
        sites = json.load(f)
    for site_id, site_data in sites.items():
        site_path = os.path.expanduser(site_data.get('path', ''))
        if site_path == '$LOCAL_SITE_ROOT':
            print(site_id)
            sys.exit(0)
except Exception as e:
    pass
" 2>/dev/null)
fi

if [ -z "$LOCAL_SITE_ID" ]; then
    echo -e "\033[1;31mError: Could not find Local site ID for this WordPress installation.\033[0m"
    echo "Make sure this site is managed by Local by Flywheel."
    exit 1
fi

echo "   Found site ID: $LOCAL_SITE_ID"

# Check if ssh-entry script exists
SSH_ENTRY_SCRIPT="$LOCAL_SSH_ENTRY_DIR/$LOCAL_SITE_ID.sh"
if [ ! -f "$SSH_ENTRY_SCRIPT" ]; then
    echo -e "\033[1;31mError: SSH entry script not found: $SSH_ENTRY_SCRIPT\033[0m"
    echo "Make sure the site is running in Local by Flywheel."
    exit 1
fi

# Source the ssh-entry script environment (exclude the exec command and cd)
echo "   Loading Local environment from: $SSH_ENTRY_SCRIPT"
eval "$(grep -E '^export ' "$SSH_ENTRY_SCRIPT")"

# Step 1: Build the release
echo ""
echo -e "\033[1;33m1. Building release package...\033[0m"
"$REPO_ROOT/bin/build-free"

# Step 2: Copy to test location
echo ""
echo -e "\033[1;33m2. Copying clean build to test location...\033[0m"

# Remove old test copy if exists
if [ -d "$TEST_PLUGIN_DIR" ]; then
    rm -rf "$TEST_PLUGIN_DIR"
fi

# Copy the clean build
cp -r "$REPO_ROOT/build/art-routes" "$TEST_PLUGIN_DIR"
echo "   Copied to: $TEST_PLUGIN_DIR"

# Step 3: Run plugin check
echo ""
echo -e "\033[1;33m3. Running Plugin Check...\033[0m"
echo ""

cd "$WP_DIR"

# Check if site is running by testing MySQL connection
if ! mysql --defaults-file="$MYSQL_HOME/my.cnf" -e "SELECT 1" &>/dev/null; then
    echo -e "\033[1;31mError: Local site is not running.\033[0m"
    echo "Please start the site in Local by Flywheel first."
    exit 1
fi

# Run the plugin check
echo "Running: wp plugin check $TEST_PLUGIN_NAME"
echo ""

# Run plugin check and filter results
wp plugin check "$TEST_PLUGIN_NAME" --require=./wp-content/plugins/plugin-check/cli.php 2>&1 | \
    grep -v "TextDomainMismatch" | \
    tee /tmp/plugin-check-results.txt

# Count errors (excluding TextDomainMismatch false positives)
ERROR_COUNT=$(grep "ERROR" /tmp/plugin-check-results.txt 2>/dev/null | wc -l | tr -d ' ')
WARNING_COUNT=$(grep "WARNING" /tmp/plugin-check-results.txt 2>/dev/null | wc -l | tr -d ' ')

echo ""
echo "========================"
echo -e "Results: \033[1;31m$ERROR_COUNT errors\033[0m, \033[1;33m$WARNING_COUNT warnings\033[0m"
echo "(TextDomainMismatch errors filtered - they're false positives from the test folder name)"

# Step 4: Cleanup
echo ""
echo -e "\033[1;33m4. Cleanup\033[0m"
rm -rf "$TEST_PLUGIN_DIR"
echo "   ✓ Cleaned up test directory"

# Exit with error if there were errors
if [ "$ERROR_COUNT" -gt 0 ]; then
    echo ""
    echo -e "\033[1;31m✗ Plugin check found errors. Fix them before release.\033[0m"
    echo "  Full results saved to: /tmp/plugin-check-results.txt"
    exit 1
else
    echo ""
    echo -e "\033[0;32m✓ Plugin check passed!\033[0m"
fi
